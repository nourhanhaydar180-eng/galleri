
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Scanner with Interactive Table</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* الأساسيات */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #2d936c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* الهيدر */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.2rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .logo i {
            font-size: 1.8rem;
        }
        
        /* التنقل الرئيسي */
        .nav-tabs {
            display: flex;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 10px 15px;
            background: transparent;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .tab-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .tab-btn.active {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* المحتوى الرئيسي */
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .tab-content {
            display: none;
            flex-direction: column;
            gap: 20px;
        }
        
        .tab-content.active {
            display: flex;
        }
        
        /* قسم الماسح الضوئي */
        .scanner-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .scanner-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        #reader {
            width: 100%;
            max-width: 500px;
            border-radius: 10px;
            overflow: hidden;
            border: 3px solid var(--border-color);
            transition: all 0.5s ease;
        }
        
        /* أضواء السكانر حسب الحالة */
        .scanner-success {
            border-color: var(--success-color) !important;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
        }
        
        .scanner-error {
            border-color: var(--danger-color) !important;
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.5);
        }
        
        .scanner-warning {
            border-color: var(--warning-color) !important;
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);
        }
        
        .scanner-info {
            border-color: var(--info-color) !important;
            box-shadow: 0 0 15px rgba(23, 162, 184, 0.5);
        }
        
        .scanner-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        /* قسم معلومات المنتج الممسوح */
        .product-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--accent-color);
            display: none;
        }
        
        .product-info.show {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        .product-info h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .product-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .product-detail {
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .product-detail .label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 2px;
        }
        
        .product-detail .value {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        /* قسم الجدول */
        .sheet-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .sheet-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* عناصر التحكم */
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-accent:hover {
            background-color: #218c68;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: var(--dark-color);
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        /* الجدول */
        .table-container {
            overflow-x: auto;
            flex: 1;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: #f1f5f9;
            font-weight: 700;
            color: var(--dark-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        td.editable {
            cursor: text;
            position: relative;
        }
        
        td.editable:focus {
            outline: 2px solid var(--primary-color);
            background-color: white;
        }
        
        .actions-cell {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--dark-color);
            transition: color 0.3s;
        }
        
        .action-btn.edit:hover {
            color: var(--primary-color);
        }
        
        .action-btn.delete:hover {
            color: var(--danger-color);
        }
        
        /* قسم المشاركة */
        .share-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: var(--shadow);
        }
        
        .share-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        
        .share-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .share-link {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
            min-width: 250px;
        }
        
        .share-link input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        /* الفوتر */
        footer {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 20px;
        }
        
        /* رسائل */
        .message {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .message.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            display: block;
        }
        
        /* تصميم متجاوب */
        @media (max-width: 1200px) {
            .container {
                max-width: 95%;
            }
        }
        
        @media (max-width: 992px) {
            .header-top {
                flex-direction: column;
                align-items: stretch;
            }
            
            .logo {
                justify-content: center;
            }
            
            .controls {
                justify-content: center;
            }
            
            .sheet-header {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            header, .scanner-section, .sheet-section, .share-section {
                padding: 15px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                padding: 12px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .tab-btn:last-child {
                border-bottom: none;
            }
            
            .scanner-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .scanner-controls .btn {
                width: 100%;
                justify-content: center;
            }
            
            .controls {
                width: 100%;
                justify-content: center;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
                min-width: 140px;
                padding: 12px;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            
            .share-options {
                flex-direction: column;
            }
            
            .share-link {
                min-width: 100%;
            }
            
            table {
                min-width: 400px;
            }
        }
        
        @media (max-width: 480px) {
            .logo {
                font-size: 1.2rem;
            }
            
            .logo i {
                font-size: 1.5rem;
            }
            
            .sheet-title {
                font-size: 1.3rem;
            }
            
            .btn {
                min-width: 120px;
                padding: 10px;
                font-size: 0.85rem;
            }
            
            th, td {
                padding: 6px 8px;
                font-size: 0.85rem;
            }
            
            #reader {
                max-width: 100%;
            }
            
            .product-details {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 360px) {
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .tab-btn {
                font-size: 0.9rem;
                padding: 10px 5px;
            }
        }
        
        /* تأثيرات إضافية */
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(45, 147, 108, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(45, 147, 108, 0); }
            100% { box-shadow: 0 0 0 0 rgba(45, 147, 108, 0); }
        }
        
        .highlight {
            background-color: #fff3cd !important;
            transition: background-color 1.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* شاشة التحميل */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* إشعارات صغيرة */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
            max-width: 300px;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.success {
            background-color: var(--success-color);
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        .notification.info {
            background-color: var(--primary-color);
        }
        
        @media (max-width: 768px) {
            .notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }
        
        /* علامات الأصوات */
        .sound-indicators {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .sound-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            padding: 5px 10px;
            border-radius: 15px;
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
        }
        
        .sound-indicator.success {
            border-color: var(--success-color);
            background-color: rgba(40, 167, 69, 0.1);
        }
        
        .sound-indicator.error {
            border-color: var(--danger-color);
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        .sound-indicator.warning {
            border-color: var(--warning-color);
            background-color: rgba(255, 193, 7, 0.1);
        }
        
        .indicator-icon {
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <div class="logo">
                <i class="fas fa-shopping-cart"></i>
                <span>Product Scanner System</span>
            </div>
            <div class="controls">
                <button class="btn btn-accent" id="clearAllBtn">
                    <i class="fas fa-trash-alt"></i> Clear All
                </button>
                <button class="btn btn-success" id="exportBtn">
                    <i class="fas fa-file-export"></i> Export Table
                </button>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="tab-btn active" data-tab="scanner-tab">
                <i class="fas fa-camera"></i> Scanner
            </button>
            <button class="tab-btn" data-tab="sheet-tab">
                <i class="fas fa-table"></i> Interactive Table
            </button>
            <button class="tab-btn" data-tab="share-tab">
                <i class="fas fa-share-alt"></i> Share Table
            </button>
        </div>
    </header>
    
    <div class="container">
        <!-- رسائل النظام -->
        <div class="message" id="message"></div>
        
        <!-- تبويب الماسح الضوئي -->
        <div class="tab-content active" id="scanner-tab">
            <div class="scanner-section">
                <h2><i class="fas fa-qrcode"></i> Scan Products with Camera</h2>
                <p>Use the camera to scan product codes (barcode, QR code) and they will be automatically added to the table.</p>
                
                <!-- قسم معلومات المنتج الممسوح -->
                <div class="product-info" id="productInfo">
                    <h4><i class="fas fa-info-circle"></i> Scanned Product</h4>
                    <div class="product-details">
                        <div class="product-detail">
                            <div class="label">Product Name</div>
                            <div class="value" id="productNameInfo">-</div>
                        </div>
                        <div class="product-detail">
                            <div class="label">Price</div>
                            <div class="value" id="productPriceInfo">-</div>
                        </div>
                        <div class="product-detail">
                            <div class="label">Category</div>
                            <div class="value" id="productCategoryInfo">-</div>
                        </div>
                        <div class="product-detail">
                            <div class="label">Status</div>
                            <div class="value" id="productStatusInfo">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="scanner-container">
                    <div id="reader"></div>
                    
                    <div class="scanner-controls">
                        <button class="btn btn-primary" id="startScannerBtn">
                            <i class="fas fa-play"></i> Start Scanner
                        </button>
                        <button class="btn btn-danger" id="stopScannerBtn">
                            <i class="fas fa-stop"></i> Stop Scanner
                        </button>
                        <button class="btn btn-accent" id="addManualBtn">
                            <i class="fas fa-plus"></i> Add Manually
                        </button>
                    </div>
                    
                    <!-- علامات الأصوات -->
                    <div class="sound-indicators">
                        <div class="sound-indicator success">
                            <span class="indicator-icon">✓</span>
                            <span>Scan Success</span>
                        </div>
                        <div class="sound-indicator error">
                            <span class="indicator-icon">✗</span>
                            <span>Scan Error</span>
                        </div>
                        <div class="sound-indicator warning">
                            <span class="indicator-icon">!</span>
                            <span>Duplicate Code</span>
                        </div>
                    </div>
                </div>
                
                <div id="scannerResult" style="text-align: center; margin-top: 15px; font-weight: 600;"></div>
            </div>
            
            <div class="sheet-section">
                <div class="sheet-header">
                    <div class="sheet-title">Recently Added Products</div>
                    <div class="controls">
                        <button class="btn btn-primary" id="addRowBtn">
                            <i class="fas fa-plus"></i> Add Row
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="20%">Product Code</th>
                                <th width="25%">Product Name</th>
                                <th width="15%">Price</th>
                                <th width="15%">Quantity</th>
                                <th width="15%">Total</th>
                                <th width="10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- الصفوف ستضاف هنا ديناميكياً -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- تبويب الجدول التفاعلي -->
        <div class="tab-content" id="sheet-tab">
            <div class="sheet-section">
                <div class="sheet-header">
                    <div class="sheet-title">Complete Products Table</div>
                    <div class="controls">
                        <button class="btn btn-primary" id="addRowSheetBtn">
                            <i class="fas fa-plus"></i> Add Row
                        </button>
                        <button class="btn btn-success" id="calculateTotalBtn">
                            <i class="fas fa-calculator"></i> Calculate Total
                        </button>
                        <button class="btn btn-warning" id="saveDataBtn">
                            <i class="fas fa-save"></i> Save Data
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="fullSheetTable">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="15%">Product Code</th>
                                <th width="25%">Product Name</th>
                                <th width="15%">Category</th>
                                <th width="10%">Price</th>
                                <th width="10%">Quantity</th>
                                <th width="10%">Total</th>
                                <th width="10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fullSheetBody">
                            <!-- سيتم ملؤه بنفس بيانات productsTable -->
                        </tbody>
                        <tfoot id="tableFooter">
                            <tr>
                                <td colspan="6" style="text-align: right; font-weight: 700;">Grand Total:</td>
                                <td id="grandTotal" style="font-weight: 700;">0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- تبويب المشاركة -->
        <div class="tab-content" id="share-tab">
            <div class="share-section">
                <h2><i class="fas fa-share-alt"></i> Share Products Table</h2>
                <p>You can share the products table with others using the following links:</p>
                
                <div class="share-controls">
                    <div class="share-options">
                        <div class="share-link">
                            <input type="text" id="jsonLink" readonly value="Link will be generated after saving the table">
                            <button class="btn btn-primary" id="copyJsonBtn">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                        
                        <div class="share-link">
                            <input type="text" id="csvLink" readonly value="Link will be generated after saving the table">
                            <button class="btn btn-primary" id="copyCsvBtn">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                    
                    <div class="controls" style="justify-content: center;">
                        <button class="btn btn-success" id="generateLinksBtn">
                            <i class="fas fa-link"></i> Generate Share Links
                        </button>
                        <button class="btn btn-accent" id="saveToFileBtn">
                            <i class="fas fa-download"></i> Save as File
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                        <h3><i class="fas fa-info-circle"></i> Sharing Information</h3>
                        <p>• Sharing links are valid for 30 days.</p>
                        <p>• Recipients can view and download the table but cannot edit it.</p>
                        <p>• To enable shared editing, save the table to Google Sheets.</p>
                        
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn btn-primary" id="openGoogleSheetsBtn">
                                <i class="fab fa-google"></i> Open in Google Sheets
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>© 2023 Product Scanner System | Developed for easy product scanning and management</p>
    </footer>

    <!-- إشعارات صغيرة -->
    <div id="notification" class="notification"></div>

    <!-- عناصر الصوت المخفية -->
    <audio id="successSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    <audio id="errorSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
    </audio>
    <audio id="duplicateSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-buzzer-1551.mp3" type="audio/mpeg">
    </audio>
    <audio id="scanSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-scanner-beep-3s-993.mp3" type="audio/mpeg">
    </audio>

    <script>
        // بيانات التطبيق
        let products = [];
        let rowCounter = 1;
        let scannerActive = false;
        let html5QrCode;
        
        // مكتبة المنتجات المحددة مسبقاً
        const productLibrary = {
            "123456789012": { name: "Milk 1L", price: "2.50", category: "Dairy" },
            "234567890123": { name: "Bread White", price: "1.20", category: "Bakery" },
            "345678901234": { name: "Eggs 12pcs", price: "3.00", category: "Dairy" },
            "456789012345": { name: "Mineral Water 1.5L", price: "0.80", category: "Beverages" },
            "567890123456": { name: "Rice 1kg", price: "2.00", category: "Grains" },
            "678901234567": { name: "Pasta 500g", price: "1.50", category: "Grains" },
            "789012345678": { name: "Tomato Sauce", price: "1.80", category: "Condiments" },
            "890123456789": { name: "Sugar 1kg", price: "1.00", category: "Baking" },
            "901234567890": { name: "Coffee 250g", price: "4.50", category: "Beverages" },
            "012345678901": { name: "Tea Bags 100pcs", price: "3.20", category: "Beverages" },
            "112233445566": { name: "Cooking Oil 1L", price: "3.50", category: "Cooking" },
            "223344556677": { name: "Flour 1kg", price: "1.20", category: "Baking" },
            "334455667788": { name: "Butter 250g", price: "2.80", category: "Dairy" },
            "445566778899": { name: "Cheese 200g", price: "3.20", category: "Dairy" },
            "556677889900": { name: "Yogurt 500g", price: "1.50", category: "Dairy" },
            "667788990011": { name: "Apple Juice 1L", price: "2.00", category: "Beverages" },
            "778899001122": { name: "Cereal 500g", price: "3.50", category: "Breakfast" },
            "889900112233": { name: "Cookies 300g", price: "2.00", category: "Snacks" },
            "990011223344": { name: "Chocolate Bar", price: "1.50", category: "Snacks" },
            "001122334455": { name: "Soap Bar", price: "0.80", category: "Personal Care" }
        };
        
        // تهيئة التطبيق
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل البيانات المحفوظة من localStorage
            loadSavedData();
            
            initTabs();
            initTable();
            initScanner();
            initButtons();
            updateFullSheetTable();
            calculateGrandTotal();
            
            // إظهار إشعار التحميل
            showNotification('Data loaded from local storage', 'success');
        });
        
        // تحميل البيانات المحفوظة
        function loadSavedData() {
            const savedData = localStorage.getItem('productScannerData');
            if (savedData) {
                try {
                    products = JSON.parse(savedData);
                    rowCounter = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                    
                    // ملء الجدول بالبيانات المحفوظة
                    products.forEach(product => {
                        addRowToTable(product, false);
                    });
                    
                    console.log(`Loaded ${products.length} products from storage`);
                } catch (e) {
                    console.error('Error loading saved data:', e);
                    products = [];
                    rowCounter = 1;
                }
            }
        }
        
        // حفظ البيانات تلقائياً
        function saveDataToStorage() {
            try {
                localStorage.setItem('productScannerData', JSON.stringify(products));
                console.log(`Saved ${products.length} products to storage`);
                
                // إظهار إشعار حفظ صغير
                showNotification('Data saved automatically', 'info');
                return true;
            } catch (e) {
                console.error('Error saving data:', e);
                showNotification('Error saving data', 'error');
                return false;
            }
        }
        
        // تهيئة نظام التبويب
        function initTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // إزالة النشاط من جميع الأزرار والمحتويات
                    tabBtns.forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // إضافة النشاط للزر والمحتوى المحدد
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // تهيئة الجدول
        function initTable() {
            const tableBody = document.getElementById('tableBody');
            
            // إضافة حدث للحذف
            tableBody.addEventListener('click', function(e) {
                if (e.target.closest('.action-btn.delete')) {
                    const row = e.target.closest('tr');
                    const rowId = parseInt(row.cells[0].textContent);
                    
                    if (confirm(`Delete product #${rowId}?`)) {
                        // إزالة المنتج من المصفوفة
                        const index = products.findIndex(p => p.id === rowId);
                        if (index !== -1) {
                            products.splice(index, 1);
                        }
                        
                        row.remove();
                        updateRowNumbers();
                        updateFullSheetTable();
                        calculateGrandTotal();
                        saveDataToStorage();
                        showMessage('Product deleted successfully', 'success');
                    }
                }
                
                // تحويل الخلايا القابلة للتحرير
                if (e.target.classList.contains('editable')) {
                    makeCellEditable(e.target);
                }
            });
            
            // تحديث أرقام الصفوف
            updateRowNumbers();
        }
        
        // جعل الخلية قابلة للتحرير
        function makeCellEditable(cell) {
            const originalValue = cell.textContent;
            const field = cell.getAttribute('data-field');
            const row = cell.closest('tr');
            const rowId = parseInt(row.cells[0].textContent);
            
            // إنشاء حقل إدخال
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalValue;
            input.style.width = '100%';
            input.style.border = 'none';
            input.style.padding = '5px';
            input.style.fontSize = 'inherit';
            input.style.fontFamily = 'inherit';
            
            // مسح محتوى الخلية وإضافة حقل الإدخال
            cell.textContent = '';
            cell.appendChild(input);
            input.focus();
            
            // حفظ التغييرات عند الضغط على Enter
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    finishEditing(cell, input.value, field, rowId);
                } else if (e.key === 'Escape') {
                    cell.textContent = originalValue;
                }
            });
            
            // حفظ التغييرات عند فقدان التركيز
            input.addEventListener('blur', function() {
                finishEditing(cell, input.value, field, rowId);
            });
        }
        
        // إنهاء تحرير الخلية
        function finishEditing(cell, newValue, field, rowId) {
            cell.textContent = newValue;
            
            // تحديث بيانات المنتج في المصفوفة
            const productIndex = products.findIndex(p => p.id === rowId);
            if (productIndex !== -1) {
                products[productIndex][field] = newValue;
                
                // تحديث القيم الحسابية إذا لزم الأمر
                if (field === 'price' || field === 'quantity') {
                    updateRowTotal(cell.closest('tr'));
                    
                    // إعادة حساب المجموع في بيانات المنتج
                    const price = parseFloat(products[productIndex].price) || 0;
                    const quantity = parseInt(products[productIndex].quantity) || 0;
                    products[productIndex].total = (price * quantity).toFixed(2);
                }
            }
            
            updateFullSheetTable();
            calculateGrandTotal();
            saveDataToStorage();
        }
        
        // تحديث المجموع للصف
        function updateRowTotal(row) {
            const priceCell = row.querySelector('[data-field="price"]');
            const quantityCell = row.querySelector('[data-field="quantity"]');
            const totalCell = row.querySelector('[data-field="total"]');
            
            const price = parseFloat(priceCell.textContent) || 0;
            const quantity = parseInt(quantityCell.textContent) || 0;
            const total = price * quantity;
            
            totalCell.textContent = total.toFixed(2);
        }
        
        // تحديث أرقام الصفوف
        function updateRowNumbers() {
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }
        
        // تهيئة الماسح الضوئي
        function initScanner() {
            html5QrCode = new Html5Qrcode("reader");
            
            document.getElementById('startScannerBtn').addEventListener('click', startScanner);
            document.getElementById('stopScannerBtn').addEventListener('click', stopScanner);
        }
        
        // تشغيل صوت
        function playSound(soundId) {
            try {
                const sound = document.getElementById(soundId);
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Sound play failed:", e));
            } catch (e) {
                console.error("Error playing sound:", e);
            }
        }
        
        // تغيير لون إطار السكانر
        function changeScannerBorder(colorClass, duration = 1000) {
            const scanner = document.getElementById('reader');
            scanner.classList.remove('scanner-success', 'scanner-error', 'scanner-warning', 'scanner-info');
            
            if (colorClass) {
                scanner.classList.add(colorClass);
                
                // إزالة اللون بعد المدة المحددة
                setTimeout(() => {
                    scanner.classList.remove(colorClass);
                }, duration);
            }
        }
        
        // إظهار معلومات المنتج الممسوح
        function showProductInfo(productData, isExisting = false) {
            const productInfo = document.getElementById('productInfo');
            const productName = document.getElementById('productNameInfo');
            const productPrice = document.getElementById('productPriceInfo');
            const productCategory = document.getElementById('productCategoryInfo');
            const productStatus = document.getElementById('productStatusInfo');
            
            productName.textContent = productData.name || 'Unknown Product';
            productPrice.textContent = productData.price ? `$${productData.price}` : '$0.00';
            productCategory.textContent = productData.category || 'General';
            productStatus.textContent = isExisting ? 'Existing (Quantity Increased)' : 'New Product Added';
            
            productInfo.classList.add('show');
            
            // إخفاء المعلومات بعد 5 ثوانٍ
            setTimeout(() => {
                productInfo.classList.remove('show');
            }, 5000);
        }
        
        // بدء المسح الضوئي
        function startScanner() {
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                if (scannerActive) {
                    // صوت المسح الضوئي
                    playSound('scanSound');
                    
                    // إيقاف الماسح مؤقتاً
                    stopScanner();
                    
                    // معالجة النتيجة بعد تأخير قصير
                    setTimeout(() => {
                        processScannedCode(decodedText);
                        
                        // إعادة تشغيل الماسح بعد معالجة الكود
                        setTimeout(() => {
                            if (!scannerActive) {
                                startScanner();
                            }
                        }, 800);
                    }, 300);
                }
            };
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .then(() => {
                    scannerActive = true;
                    document.getElementById('scannerResult').textContent = 'Scanning...';
                    document.getElementById('scannerResult').style.color = 'var(--accent-color)';
                    showMessage('Scanner started successfully', 'success');
                    changeScannerBorder('scanner-info', 1500);
                })
                .catch(err => {
                    console.error("Scanner start error:", err);
                    showMessage('Failed to start scanner. Please check camera permissions.', 'error');
                    playSound('errorSound');
                    changeScannerBorder('scanner-error', 2000);
                });
        }
        
        // إيقاف المسح الضوئي
        function stopScanner() {
            if (scannerActive) {
                html5QrCode.stop()
                    .then(() => {
                        scannerActive = false;
                        document.getElementById('scannerResult').textContent = 'Scanner stopped';
                        document.getElementById('scannerResult').style.color = 'var(--danger-color)';
                    })
                    .catch(err => {
                        console.error("Scanner stop error:", err);
                    });
            }
        }
        
        // معالجة الكود الممسوح
        function processScannedCode(code) {
            // التحقق من صحة الكود
            if (!code || code.trim() === '') {
                showMessage('Invalid code scanned', 'error');
                playSound('errorSound');
                changeScannerBorder('scanner-error', 1500);
                return;
            }
            
            // البحث عن معلومات المنتج في المكتبة
            const productData = productLibrary[code] || { 
                name: 'New Product', 
                price: '0.00', 
                category: 'General' 
            };
            
            // البحث عما إذا كان المنتج موجودًا بالفعل في الجدول
            const existingRow = Array.from(document.querySelectorAll('#tableBody [data-field="code"]'))
                .find(cell => cell.textContent === code);
            
            if (existingRow) {
                // زيادة الكمية إذا كان المنتج موجودًا
                const row = existingRow.closest('tr');
                const quantityCell = row.querySelector('[data-field="quantity"]');
                const currentQty = parseInt(quantityCell.textContent) || 0;
                quantityCell.textContent = currentQty + 1;
                updateRowTotal(row);
                
                // تحديث بيانات المنتج في المصفوفة
                const rowId = parseInt(row.cells[0].textContent);
                const productIndex = products.findIndex(p => p.id === rowId);
                if (productIndex !== -1) {
                    products[productIndex].quantity = currentQty + 1;
                    const price = parseFloat(products[productIndex].price) || 0;
                    products[productIndex].total = (price * (currentQty + 1)).toFixed(2);
                }
                
                // تأثيرات للكود المكرر
                playSound('duplicateSound');
                changeScannerBorder('scanner-warning', 1500);
                row.classList.add('highlight');
                setTimeout(() => row.classList.remove('highlight'), 1500);
                
                showMessage('Product quantity increased', 'success');
                showProductInfo(productData, true);
            } else {
                // إضافة منتج جديد
                const newProduct = {
                    id: rowCounter++,
                    code: code,
                    name: productData.name,
                    price: productData.price,
                    category: productData.category,
                    quantity: 1,
                    total: productData.price
                };
                
                newProduct.total = (parseFloat(newProduct.price) * newProduct.quantity).toFixed(2);
                products.push(newProduct);
                
                addRowToTable(newProduct);
                
                // تأثيرات للإضافة الجديدة
                playSound('successSound');
                changeScannerBorder('scanner-success', 1500);
                
                showMessage('New product added', 'success');
                showProductInfo(productData, false);
            }
            
            updateFullSheetTable();
            calculateGrandTotal();
            saveDataToStorage();
        }
        
        // إضافة منتج من المسح الضوئي
        function addProductFromScan(code) {
            processScannedCode(code);
        }
        
        // إضافة صف إلى الجدول
        function addRowToTable(product, saveToStorage = true) {
            const tableBody = document.getElementById('tableBody');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>${product.id}</td>
                <td class="editable" data-field="code">${product.code}</td>
                <td class="editable" data-field="name">${product.name}</td>
                <td class="editable" data-field="price">${product.price}</td>
                <td class="editable" data-field="quantity">${product.quantity}</td>
                <td data-field="total">${product.total}</td>
                <td class="actions-cell">
                    <button class="action-btn edit" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn delete" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(newRow);
            updateRowNumbers();
            
            if (saveToStorage) {
                saveDataToStorage();
            }
        }
        
        // تحديث جدول البيانات الكامل
        function updateFullSheetTable() {
            const fullSheetBody = document.getElementById('fullSheetBody');
            fullSheetBody.innerHTML = '';
            
            // جمع البيانات من الجدول الرئيسي
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach(row => {
                const newRow = document.createElement('tr');
                
                newRow.innerHTML = `
                    <td>${row.cells[0].textContent}</td>
                    <td>${row.cells[1].textContent}</td>
                    <td>${row.cells[2].textContent}</td>
                    <td>General</td>
                    <td>${row.cells[3].textContent}</td>
                    <td>${row.cells[4].textContent}</td>
                    <td>${row.cells[5].textContent}</td>
                    <td class="actions-cell">
                        <button class="action-btn delete" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                fullSheetBody.appendChild(newRow);
            });
        }
        
        // حساب المجموع الكلي
        function calculateGrandTotal() {
            const totalCells = document.querySelectorAll('[data-field="total"]');
            let grandTotal = 0;
            
            totalCells.forEach(cell => {
                grandTotal += parseFloat(cell.textContent) || 0;
            });
            
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
            saveDataToStorage();
        }
        
        // تهيئة الأزرار
        function initButtons() {
            // إضافة صف
            document.getElementById('addRowBtn').addEventListener('click', addNewRow);
            document.getElementById('addRowSheetBtn').addEventListener('click', addNewRow);
            
            // إضافة يدويًا
            document.getElementById('addManualBtn').addEventListener('click', function() {
                const productCode = prompt('Enter product code (barcode):');
                if (productCode) {
                    addProductFromScan(productCode);
                }
            });
            
            // حفظ البيانات يدويًا
            document.getElementById('saveDataBtn').addEventListener('click', function() {
                if (saveDataToStorage()) {
                    showMessage('Data saved successfully', 'success');
                }
            });
            
            // مسح الكل
            document.getElementById('clearAllBtn').addEventListener('click', function() {
                if (confirm('Delete all products? This action cannot be undone.')) {
                    document.getElementById('tableBody').innerHTML = '';
                    document.getElementById('productInfo').classList.remove('show');
                    products = [];
                    rowCounter = 1;
                    updateFullSheetTable();
                    calculateGrandTotal();
                    saveDataToStorage();
                    showMessage('All products deleted', 'success');
                }
            });
            
            // تصدير الجدول
            document.getElementById('exportBtn').addEventListener('click', exportTable);
            
            // إنشاء روابط المشاركة
            document.getElementById('generateLinksBtn').addEventListener('click', generateShareLinks);
            
            // نسخ الروابط
            document.getElementById('copyJsonBtn').addEventListener('click', function() {
                copyToClipboard('jsonLink');
            });
            
            document.getElementById('copyCsvBtn').addEventListener('click', function() {
                copyToClipboard('csvLink');
            });
            
            // حفظ كملف
            document.getElementById('saveToFileBtn').addEventListener('click', saveTableToFile);
            
            // فتح في Google Sheets
            document.getElementById('openGoogleSheetsBtn').addEventListener('click', openInGoogleSheets);
            
            // حساب الإجمالي
            document.getElementById('calculateTotalBtn').addEventListener('click', calculateGrandTotal);
            
            // حفظ البيانات عند إغلاق الصفحة
            window.addEventListener('beforeunload', function() {
                saveDataToStorage();
            });
        }
        
        // إضافة صف جديد
        function addNewRow() {
            const newProduct = {
                id: rowCounter++,
                code: `NEW${Date.now().toString().slice(-6)}`,
                name: 'New Product',
                price: '0.00',
                quantity: '1',
                total: '0.00'
            };
            
            addRowToTable(newProduct);
            updateFullSheetTable();
            calculateGrandTotal();
            showMessage('New row added', 'success');
        }
        
        // تصدير الجدول
        function exportTable() {
            const rows = [];
            const header = ['#', 'Product Code', 'Product Name', 'Price', 'Quantity', 'Total'];
            rows.push(header.join(','));
            
            const tableRows = document.querySelectorAll('#tableBody tr');
            tableRows.forEach(row => {
                const rowData = [
                    row.cells[0].textContent,
                    row.cells[1].textContent,
                    row.cells[2].textContent,
                    row.cells[3].textContent,
                    row.cells[4].textContent,
                    row.cells[5].textContent
                ];
                rows.push(rowData.join(','));
            });
            
            const csvContent = rows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'products_' + new Date().toISOString().slice(0, 10) + '.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('Table exported successfully', 'success');
        }
        
        // إنشاء روابط المشاركة
        function generateShareLinks() {
            const tableData = getTableData();
            const jsonData = JSON.stringify(tableData);
            const csvData = convertToCSV(tableData);
            
            // في تطبيق حقيقي، هنا يتم رفع البيانات إلى خادم والحصول على روابط حقيقية
            // لكننا سنقوم بمحاكاة ذلك
            
            const baseUrl = window.location.href.split('#')[0];
            document.getElementById('jsonLink').value = `${baseUrl}#data=${btoa(jsonData)}`;
            document.getElementById('csvLink').value = `${baseUrl}#csv=${btoa(csvData)}`;
            
            showMessage('Share links generated successfully', 'success');
        }
        
        // الحصول على بيانات الجدول
        function getTableData() {
            const tableData = [];
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                tableData.push({
                    id: row.cells[0].textContent,
                    code: row.cells[1].textContent,
                    name: row.cells[2].textContent,
                    price: row.cells[3].textContent,
                    quantity: row.cells[4].textContent,
                    total: row.cells[5].textContent
                });
            });
            
            return tableData;
        }
        
        // تحويل إلى CSV
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const rows = data.map(row => 
                headers.map(header => JSON.stringify(row[header])).join(',')
            );
            
            return [headers.join(','), ...rows].join('\n');
        }
        
        // نسخ إلى الحافظة
        function copyToClipboard(inputId) {
            const input = document.getElementById(inputId);
            input.select();
            input.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(input.value)
                .then(() => {
                    showMessage('Link copied to clipboard', 'success');
                })
                .catch(err => {
                    console.error('Failed to copy link: ', err);
                    showMessage('Failed to copy link', 'error');
                });
        }
        
        // حفظ الجدول كملف
        function saveTableToFile() {
            const tableData = getTableData();
            const jsonData = JSON.stringify(tableData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'products_' + new Date().toISOString().slice(0, 10) + '.json');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('Table saved as JSON file', 'success');
        }
        
        // فتح في Google Sheets (محاكاة)
        function openInGoogleSheets() {
            showMessage('Opening in Google Sheets. In a real app, data would be uploaded to Google Sheets.', 'success');
            
            // محاكاة التأخير
            setTimeout(() => {
                const tableData = getTableData();
                const csvData = convertToCSV(tableData);
                const encodedData = encodeURIComponent(csvData);
                
                // رابط Google Sheets لإنشاء جدول جديد
                const googleSheetsUrl = `https://docs.google.com/spreadsheets/create?usp=sharing&data=${encodedData}`;
                
                // فتح نافذة جديدة
                window.open(googleSheetsUrl, '_blank');
            }, 1000);
        }
        
        // عرض الرسائل
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            
            // إخفاء الرسالة بعد 3 ثوانٍ
            setTimeout(() => {
                messageEl.className = 'message';
            }, 3000);
        }
        
        // عرض إشعار صغير
        function showNotification(text, type) {
            const notification = document.getElementById('notification');
            notification.textContent = text;
            notification.className = `notification ${type} show`;
            
            // إخفاء الإشعار بعد 3 ثوانٍ
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
